<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Embedded SDK: Screens Stack and dynamic objects management</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Embedded SDK
   </div>
   <div id="projectbrief">Embedded SDK</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">Embedded SDK</a></li><li class="navelem"><a class="el" href="nbgl_mainpage.html">New BOLOS Graphic API for Stax/Flex</a></li>  </ul>
</div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Screens Stack and dynamic objects management </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="nbgl_screens_and_objs_intro"></a>
Introduction</h1>
<p>This chapter describes briefly how <b>NBGL</b> manages the screens stack and the dynamically allocated objects</p>
<h1><a class="anchor" id="nbgl_screens_mngt"></a>
Screens stack management</h1>
<p>All windows are full screens, some of them are considered as modals when they are displayed on top of existing ones, catching all user events (on Touchscreen), and giving back the display (and the focus) once they are dismissed.</p>
<p>Let's take the simple example of pin-validation window, which is displayed automatically after a period of inactivity, when the wallet is locked:</p>
<p><img src="LockUnlock.png" alt="" height="300" class="inline" title="caption"/></p>
<p>Pin-validation window doesn't want to take care of the current screen, and to restore it afterwards.</p>
<p>That's why it is created in a separate layer, called <em>screen</em>.</p>
<p>Screens* are organized in a stack. The top of the stack is recovering the previous screen, which is recovering the previous one, and so on.</p>
<p>Even if its size is static, the screens stack is considered as empty at start-up. Then most of windows (and even all of them for applications) are simply created in the background layer of the stack (index 0), by using <a class="el" href="nbgl__screen_8h.html#a099925e24b43d3f259d61e4761346507">nbgl_screenSet()</a> function.</p>
<p>When a modal window needs to be displayed, a new screen is pushed on the stack and graphical objects are attached to this new screen as its children (<a class="el" href="nbgl__screen_8h.html#a0e468f89cce352ae660d47511ceb4936">nbgl_screenPush()</a> function)</p>
<p>Then, once this modal window is dismissed, it calls <a class="el" href="nbgl__screen_8h.html#a93d1ccd6c8af6fc0c205e8c2c283282b">nbgl_screenPop()</a> function to remove it from the stack (even if it is not top of stack anymore), and adapt top of stack if necessary.</p>
<p><img src="Pop_screens.png" alt="" height="400" class="inline" title="caption"/></p>
<p>After any of these operations, <a class="el" href="nbgl__screen_8h.html#ad6821d8742004d473146aa1ca12fbbcb">nbgl_screenRedraw()</a> needs to be called to actually draw the objects on Display.</p>
<h1><a class="anchor" id="nbgl_objs_mngt"></a>
Dynamic objects management</h1>
<p>In order to save RAM by not statically allocating memory for all graphic objects of the UX, a dynamic objects allocator has been developed.</p>
<p>On the contrary of a regular dynamic memory allocator like malloc(), objects allocated for a given layer (= screen) are released all at once, usually when the screen is removed (or when a new one is build in replacement of it).</p>
<p>Actually, there are two different allocators:</p>
<ul>
<li>One for graphic objects (all derived from <a class="el" href="nbgl__obj_8h.html#af579f3c2ec9b53d8a3046dcf213d856a">nbgl_obj_t</a>)</li>
<li>One for containers of object pointers, used for screen/container/panel children.</li>
</ul>
<p>The containers of object pointers are arrays of pointers on nbgl_obj_t.</p>
<p>Because these two types of dynamic data are released by layer (= screen), the layer index is passed in all allocation/release API.</p>
<h2><a class="anchor" id="nbgl_objs_mngt_api"></a>
API</h2>
<p>The API to get a single graphic object of the given <b>type</b> from pool, for the given <b>layer</b> is</p>
<ul>
<li>nbgl_obj_t* <a class="el" href="nbgl__obj_8h.html#a550edb55622d58e7f7832fb4fae6d1d5">nbgl_objPoolGet(nbgl_obj_type_t type, uint8_t layer)</a></li>
</ul>
<p>The API to release all objects for a given layer is:</p>
<ul>
<li>void <a class="el" href="nbgl__obj_8h.html#ae7704eb0c272efa1b69204327fe7be7d">nbgl_objPoolRelease(uint8_t layer)</a></li>
</ul>
<p>The API to get an array of <b>nbObjs</b> object pointers, for the given <b>layer:</b> </p>
<ul>
<li>nbgl_obj_t** <a class="el" href="nbgl__obj_8h.html#a3a8bb04867792fa2f0e67222730beb91">nbgl_containerPoolGet(uint8_t nbObjs, uint8_t layer)</a></li>
</ul>
<p>The API to release all objects pointers for a given <b>layer</b> is:</p>
<ul>
<li>void <a class="el" href="nbgl__obj_8h.html#a759fce316adba848fb6a6c8d09c51a80">nbgl_containerPoolRelease(uint8_t layer)</a></li>
</ul>
<dl class="section note"><dt>Note</dt><dd><b>layer</b> can be either 0 for the background (when using <a class="el" href="nbgl__screen_8h.html#a099925e24b43d3f259d61e4761346507">nbgl_screenSet()</a>) or the return value of <a class="el" href="nbgl__screen_8h.html#a0e468f89cce352ae660d47511ceb4936">nbgl_screenPush()</a></dd></dl>
<h2><a class="anchor" id="nbgl_objs_mngt_automatic"></a>
Automatic allocation and release</h2>
<p>The container for children of a screen are automatically allocated by <a class="el" href="nbgl__screen_8h.html#a099925e24b43d3f259d61e4761346507">nbgl_screenSet()</a> or <a class="el" href="nbgl__screen_8h.html#a0e468f89cce352ae660d47511ceb4936">nbgl_screenPush()</a>. It is also automatically release by the next call to <a class="el" href="nbgl__screen_8h.html#a099925e24b43d3f259d61e4761346507">nbgl_screenSet()</a> (before new allocation) or by <a class="el" href="nbgl__screen_8h.html#a93d1ccd6c8af6fc0c205e8c2c283282b">nbgl_screenPop()</a>.</p>
<p>In the same spirit, all objects allocated for a given screen by the caller are released by the next call to <a class="el" href="nbgl__screen_8h.html#a099925e24b43d3f259d61e4761346507">nbgl_screenSet()</a> or by <a class="el" href="nbgl__screen_8h.html#a93d1ccd6c8af6fc0c205e8c2c283282b">nbgl_screenPop()</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
